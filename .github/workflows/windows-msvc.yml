name: Windows MSVC Release
on: 
  push:
    tags:
      - "*"

jobs:
  build_and_release:
    strategy:
      matrix:
        include:
          - name: win64_msvc
            os: windows-2022
            build_type: Release
            compiler_type: msvc2019_64
            msvc_arch: x64
            qt_arch: win64_msvc2019_64
            qt_version: 5.15.2
            qt_target: desktop
    runs-on: ${{ matrix.os }}
    env:
      BUILD_TYPE: ${{ matrix.build_type }}
      COMPILER_TYPE: ${{ matrix.compiler_type }}
      QT_VERSION: ${{ matrix.qt_version }}
      OPENSSL_ROOT_DIR: C:\Program Files\OpenSSL
      OPENSSL_INCLUDE_DIR: C:\Program Files\OpenSSL\include
      OPENSSL_CRYPTO_LIBRARY: C:\Program Files\OpenSSL\lib
    steps:
      # force 6.2.2 version of Inno Setup
      # - name: Install Inno Setup
      #   run: |
      #     choco install innosetup --version 6.2.2 --allow-downgrade -y

      - name: '⚙️ Cache Qt'
        id: cache-qt
        uses: actions/cache@v3
        with:
          path: ..\Qt
          key: Windows-QtCache-${{ env.QT_VERSION }}

      - name: Install Qt ${{ env.QT_VERSION }}
        uses: jurplel/install-qt-action@v3
        with:
          aqtversion: '==3.1.*'
          version: ${{ env.QT_VERSION }}
          target: ${{ matrix.qt_target }}
          arch: ${{ matrix.qt_arch }}
          # modules: 'qt5compat'
          # cached: 'false'
          cached: ${{ steps.cache-qt.outputs.cache-hit }}

      # Use CMake 3.31.x for better OpenSSL 3.x compatibility while supporting VS 2022
      - name: Setup cmake
        uses: lukka/get-cmake@latest
        with:
          cmakeVersion: 3.31.5
          ninjaVersion: 1.11.1

      - name: Checkout
        uses: actions/checkout@v4
        with:
          path: source
          fetch-depth: 0

      - name: msvc-build
        id: build
        shell: cmd
        env:
          vc_arch: ${{ matrix.msvc_arch }}
          cmake_gen: Visual Studio 17 2022
          COO_PROJECT: dde-cooperation
          DT_PROJECT: data-transfer
          BONJOUR_SDK: ${{ github.workspace }}\source\3rdparty\ext\BonjourSDK
        run: |
          REM Use Visual Studio 2022 Enterprise (pre-installed on Windows 2022 runner)
          set "VS2022_PATH=C:\Program Files\Microsoft Visual Studio\2022\Enterprise"
          if not exist "%VS2022_PATH%\VC\Auxiliary\Build\vcvarsall.bat" (
            echo Visual Studio 2022 Enterprise not found at expected location!
            exit /b 1
          )
          echo Using Visual Studio 2022 at: %VS2022_PATH%
          call "%VS2022_PATH%\VC\Auxiliary\Build\vcvarsall.bat" %vc_arch%
          
          REM Initialize OpenSSL environment (based on start.bat logic)
          echo ============== OpenSSL Initialization ==============
          echo Setting up OpenSSL environment...
          
          REM Add OpenSSL bin directory to PATH (following start.bat pattern)
          set "PATH=%PATH%;%OPENSSL_ROOT_DIR%\bin"
          echo Updated PATH: %OPENSSL_ROOT_DIR%\bin added to PATH
          
          REM Verify OpenSSL installation (like start.bat does)
          echo.
          echo Verifying OpenSSL installation:
          openssl version -a
          echo.
          echo OpenSSL environment ready
          echo ================================================
          
          REM Display key OpenSSL environment variables
          echo OpenSSL Configuration:
          echo   OPENSSL_ROOT_DIR: %OPENSSL_ROOT_DIR%
          echo   OPENSSL_INCLUDE_DIR: %OPENSSL_INCLUDE_DIR%
          echo   OPENSSL_CRYPTO_LIBRARY: %OPENSSL_CRYPTO_LIBRARY%
          echo.
          
          mkdir build && cd build
          mkdir installer-inno
          echo Current working directory: %CD%
          echo Source directory: %GITHUB_WORKSPACE%\source
          if exist "%GITHUB_WORKSPACE%\source\CMakeLists.txt" (
            echo Found CMakeLists.txt in source directory
            cmake -G "%cmake_gen%" -A %vc_arch% -D CMAKE_BUILD_TYPE=%BUILD_TYPE% -D APP_VERSION="${{ github.ref_name }}" "%GITHUB_WORKSPACE%\source"
          ) else (
            echo ERROR: CMakeLists.txt not found in source directory
            dir "%GITHUB_WORKSPACE%\source"
            exit /b 1
          )
          cmake --build . --config %BUILD_TYPE%

          echo ------------copy files to output directory------------

          if exist output\%BUILD_TYPE% (
              copy output\%BUILD_TYPE%\* output\%COO_PROJECT%\%BUILD_TYPE%\ > NUL
              REM del output\%COO_PROJECT%\%BUILD_TYPE%\quazip* > NUL
              
              copy "%OPENSSL_ROOT_DIR%\bin\libcrypto-3-x64.dll" output\%COO_PROJECT%\%BUILD_TYPE%\ > NUL
              copy "%OPENSSL_ROOT_DIR%\bin\libssl-3-x64.dll" output\%COO_PROJECT%\%BUILD_TYPE%\ > NUL
              
              mkdir installer-inno\%COO_PROJECT%
              copy "%BONJOUR_SDK%\Bonjour64.msi" installer-inno\%COO_PROJECT%\ > NUL
              if exist output\%COO_PROJECT%\%BUILD_TYPE%\vc_redist.x64.exe (
                  move output\%COO_PROJECT%\%BUILD_TYPE%\vc_redist.x64.exe installer-inno\%COO_PROJECT%\ > NUL
              )


              REM copy output\%BUILD_TYPE%\quazip* output\%DT_PROJECT%\%BUILD_TYPE%\ > NUL
              
              copy "%OPENSSL_ROOT_DIR%\bin\libcrypto-3-x64.dll" output\%DT_PROJECT%\%BUILD_TYPE%\ > NUL
              copy "%OPENSSL_ROOT_DIR%\bin\libssl-3-x64.dll" output\%DT_PROJECT%\%BUILD_TYPE%\ > NUL
              mkdir installer-inno\%DT_PROJECT%
              copy "%B_BONJOUR%\Bonjour64.msi" installer-inno\%DT_PROJECT%\ > NUL
              if exist output\%DT_PROJECT%\%BUILD_TYPE%\vc_redist.x64.exe (
                  move output\%DT_PROJECT%\%BUILD_TYPE%\vc_redist.x64.exe installer-inno\%DT_PROJECT%\ > NUL
              )
          ) else (
              echo Remember to copy supporting binaries and configuration files!
          )

          echo Build completed successfully

      - name: Inno Setup data-transfer
        uses: nadeemjazmawe/inno-setup-action-cli@v6.0.5
        with:
          filepath: build/deepin-data-transfer-setup.iss

      - name: Inno Setup cooperation
        uses: nadeemjazmawe/inno-setup-action-cli@v6.0.5
        with:
          filepath: build/dde-cooperation-setup.iss

      - name: Make Installer Directories
        run: |
          move build/installer-inno/deepin-cooperation-* build/installer-inno/dde-cooperation/ > NUL
          powershell -Command "Compress-Archive -Path build/installer-inno/dde-cooperation/* -DestinationPath build/installer-inno/dde-cooperation.zip"
          move build/installer-inno/deepin-datatransfer-* build/installer-inno/data-transfer/ > NUL
          powershell -Command "Compress-Archive -Path build/installer-inno/data-transfer/* -DestinationPath build/installer-inno/deepin-data-transfer.zip"

      - name: Create Release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          files: build/installer-inno/*.zip
          generate_release_notes: true
          draft: true
